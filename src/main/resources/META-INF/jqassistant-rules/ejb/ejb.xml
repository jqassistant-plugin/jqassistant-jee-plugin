<jqassistant-rules xmlns="http://schema.jqassistant.org/rule/v1.10"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://schema.jqassistant.org/rule/v1.10 http://schema.jqassistant.org/rule/jqassistant-rule-v1.10.xsd">

    <concept id="ejb:EJB">
        <description>Provides EJB types as ":EJB".</description>
        <cypher><![CDATA[
           MATCH
             (type:Java:Type:JEE:EJB)
           RETURN
             type as EJB
           ORDER BY
             type.fqn
        ]]></cypher>
    </concept>

    <concept id="ejb:StatelessSessionBean">
        <description>Abstract concept that returns all Stateless Session Beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:EJB:Stateless)
            RETURN t AS EJB
        ]]></cypher>
    </concept>

    <concept id="ejb:StatefulSessionBean">
        <description>Abstract concept that returns all Stateful Session Beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:EJB:Stateful)
            RETURN t AS EJB
        ]]></cypher>
    </concept>

    <concept id="ejb:SingletonBean">
        <description>Abstract concept that returns all Singleton Beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:EJB:Singleton)
            RETURN t AS EJB
        ]]></cypher>
    </concept>

    <concept id="ejb:MessageDrivenBean">
        <description>Abstract concept that returns all Message Driven Beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:EJB:MessageDriven)
            RETURN t AS EJB
        ]]></cypher>
    </concept>

    <concept id="ejb:Local">
        <description>Abstract concept that returns all local beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:Local)
            RETURN t AS LocalBean
        ]]></cypher>
    </concept>

    <concept id="ejb:Remote">
        <description>Abstract concept that returns all remote beans.</description>
        <cypher><![CDATA[
            MATCH (t:Type:JEE:Remote)
            RETURN t AS RemoteBean
        ]]></cypher>
    </concept>

    <concept id="ejb:Schedule">
        <description>Abstract concept that returns all Schedule-Methods.</description>
        <cypher><![CDATA[
            MATCH (m:Method:JEE:Schedule)
            RETURN m AS ScheduledMethod
        ]]></cypher>
    </concept>

    <concept id="ejb:TransactionAttribute">
        <description>Abstract concept that returns configured transaction attributes based on type and method level annotations.</description>
        <cypher><![CDATA[
            MATCH
              (ejb:Java:Type:JEE:EJB)-[:DECLARES]->(method:Java:Method)
            RETURN
              ejb AS Ejb,
              ejb.transactionAttribute AS TypeLevelTransactionAttribute,
              method AS Method,
              method.transactionAttribute AS MethodLevelTransactionAttribute
        ]]></cypher>
    </concept>

    <concept id="ejb:TransactionalMethod">
        <providesConcept refId="jee-transaction:TransactionalMethod" />
        <requiresConcept refId="ejb:EJB" />
        <description>
            Labels methods of EJBs with "JEE" and "Transactional". It further sets the default transaction propagation semantics for all declared transactional methods.
        </description>
        <cypher><![CDATA[
           MATCH
             (transactionalClass:Java:Type:JEE:EJB)-[:DECLARES]->(transactionalMethod:Java:Method)
           WHERE NOT (
             transactionalMethod:Constructor
             OR (transactionalMethod.static IS NOT NULL and transactionalMethod.static)
             OR transactionalMethod.visibility = "private"
           )
           SET
             transactionalMethod:JEE:Transactional
           SET
             transactionalMethod.transactionPropagation = 'REQUIRED'
           RETURN
             transactionalClass as TransactionalClass, collect(transactionalMethod) as TransactionalMethods
        ]]></cypher>
    </concept>

    <concept id="ejb:TypeLevelTransactionPropagation">
        <providesConcept refId="jee-transaction:TransactionalMethod"/>
        <requiresConcept refId="ejb:TransactionalMethod"/>
        <!-- Ensure that the type level transaction attribute overrides the default -->
        <requiresConcept refId="ejb:TransactionAttribute"/>
        <description>
            Overrides the default transaction propagation semantics of declared transactional methods based on the type level transaction attribute.
        </description>
        <cypher><![CDATA[
            MATCH
              (transactionalClass:Java:Type:JEE:EJB)-[:DECLARES]->(transactionalMethod:Java:Method:JEE:Transactional)
            WHERE
              transactionalClass.transactionAttribute IS NOT NULL
            SET
              transactionalMethod.transactionPropagation = transactionalClass.transactionAttribute
            RETURN
              transactionalClass as TransactionalClass,
              transactionalMethod as TransactionalMethod,
              transactionalMethod.transactionPropagation AS TransactionPropagation
        ]]></cypher>
    </concept>

    <concept id="ejb:MethodLevelTransactionPropagation">
        <providesConcept refId="jee-transaction:TransactionalMethod"/>
        <!-- Ensure that method level transaction attributes override the type level transaction attribute -->
        <requiresConcept refId="ejb:TypeLevelTransactionPropagation"/>
        <description>
            Overrides the transaction propagation semantics of declared transactional methods based on the method level transaction attribute.
        </description>
        <cypher><![CDATA[
            MATCH
              (transactionalClass:Java:Type:JEE:EJB)-[:DECLARES]->(transactionalMethod:Java:Method:JEE:Transactional)
            WHERE
              transactionalMethod.transactionAttribute IS NOT NULL
            SET
              transactionalMethod.transactionPropagation = transactionalMethod.transactionAttribute
            RETURN
              transactionalClass as TransactionalClass,
              transactionalMethod as TransactionalMethod,
              transactionalMethod.transactionPropagation AS TransactionPropagation
        ]]></cypher>
    </concept>

    <concept id="ejb:Injectable">
        <providesConcept refId="jee-injection:Injectable"/>
        <requiresConcept refId="ejb:EJB" />
        <description>
            Labels EJBs with "Injectable" and "CDI". The label "CDI" is set as CDI-injection is also applicable to EJBs.
        </description>
        <cypher><![CDATA[
           MATCH
             (type:Java:Type:JEE:EJB)
           SET
             type:Injectable:CDI
           RETURN
             type as EJB
        ]]></cypher>
    </concept>

    <constraint id="ejb:ScheduleMethodInEjbContext">
        <requiresConcept refId="ejb:EJB"/>
        <requiresConcept refId="ejb:Schedule"/>
        <description>Check that Schedule methods are only delared in EJB classes.</description>
        <cypher><![CDATA[
            MATCH (c:Class)-[:DECLARES]->(m:Method:Schedule)
            WHERE NOT c:EJB
            RETURN c.fqn AS invalidBean, m.name AS scheduledMethodName
        ]]></cypher>
    </constraint>

    <constraint id="ejb:AvoidStatefulSessionBeans">
        <requiresConcept refId="ejb:StatefulSessionBean"/>
        <description>Stateful Session Beans should be avoided.</description>
        <cypher><![CDATA[
            MATCH (type:Type:EJB:Stateful)
            RETURN type AS `Stateful Session Bean`
        ]]></cypher>
    </constraint>

</jqassistant-rules>
