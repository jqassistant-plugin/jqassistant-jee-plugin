<jqassistant-rules xmlns="http://schema.jqassistant.org/rule/v2.2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://schema.jqassistant.org/rule/v2.2 https://jqassistant.github.io/jqassistant/current/schema/jqassistant-rule-v2.2.xsd">

    <group id="jee-transaction:Default">
        <includeConstraint refId="jee-transaction:TransactionalMethodMustNotBeInvokedFromSameClassOrSubclass"/>
        <includeConstraint refId="jee-transaction:PrivateMethodMustNotBeAnnotatedWithTransactional"/>
    </group>

    <constraint id="jee-transaction:TransactionalMethodMustNotBeInvokedFromSameClassOrSubclass">
        <requiresConcept refId="jee-transaction:TransactionalMethod"/>
        <requiresConcept refId="java:GeneratedType"/>
        <requiresConcept refId="java:MemberInheritedFrom"/>
        <description>Transactional methods must not be invoked from the same class or from a subclass within the inheritance hierarchy.</description>
        <cypher><![CDATA[
            MATCH
              (artifact:Artifact)-[:CONTAINS]->(callingType:Java:Type),
              (callingType)-[:EXTENDS|IMPLEMENTS*0..]->(:Java:Type)-[:DECLARES]->(calledMethod:Method:JEE:Transactional),
              (callingType)-[:DECLARES]->(callingMethod:Method)-[invokes:INVOKES]->(calledMethod)
            WHERE NOT (
              artifact:Test
              OR callingType:Generated
              OR (callingMethod.synthetic IS NOT NULL and callingMethod.synthetic)
            )
            RETURN
              DISTINCT callingType as Type,
              callingMethod as Method,
              calledMethod as TransactionalMethod,
              invokes.lineNumber as LineNumber
        ]]></cypher>
        <report primaryColumn="Method"/>
    </constraint>

    <constraint id="jee-transaction:PrivateMethodMustNotBeAnnotatedWithTransactional">
        <requiresConcept refId="java:GeneratedType"/>
        <description>Private methods must not be annotated with "jakarta.transaction.Transactional"
            or "javax.transaction.Transactional".</description>
        <cypher><![CDATA[
           MATCH
             (artifact:Artifact)-[:CONTAINS]->(type:Java:Type)-[:DECLARES]->(method:Java:Method {visibility: "private"}),
             (method:Method)-[:ANNOTATED_BY]->()-[:OF_TYPE]->(annotationType:Java:Type)
           WHERE
             annotationType.fqn in [
               "jakarta.transaction.Transactional",
               "javax.transaction.Transactional"
             ]
           AND NOT (
             artifact:Test
             OR type:Generated
           )
           RETURN
             type as Type, method as Method
        ]]></cypher>
        <report primaryColumn="method"/>
    </constraint>

    <concept id="jee-transaction:TransactionalMethod">
        <description>Provides transactional methods as ":JEE:Transactional:Method".</description>
        <cypher><![CDATA[
           MATCH
             (type:Type)-[:DECLARES]->(transactionalMethod:JEE:Transactional:Method)
           RETURN
             type as Type,
             transactionalMethod as TransactionalMethod,
             transactionalMethod.transactionPropagation as TransactionPropagation
           ORDER BY
             type.fqn, transactionalMethod.signature
        ]]></cypher>
    </concept>

</jqassistant-rules>